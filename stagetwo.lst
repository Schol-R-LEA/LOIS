     1                                  ;;;;;;;;;;;;;;;;;
     2                                  ;; stagetwo.asm - second stage boot loader
     3                                  ;; 
     4                                  ;; v 0.01  Joseph Osako 3 June 2002
     5                                  ;; v 0.02  Joseph Osako 7 Sept 2006
     6                                  ;;         * restarted project, files place under source control.
     7                                  ;;         * Modifications for FAT12 based loader begun. 
     8                                  ;;
     9                                  ;; 
    10                                  
    11                                  %define stage2_base 0x1000      ; the segment:offset to load 
    12                                  %define stage2_offset 0x0000	; the second stage into
    13                                  	
    14                                  VBIOS	        equ 0x10        ; BIOS interrupt vector for video services
    15                                  set_cursor      equ 0x02        ; set the cursor to the given x,y coordinates
    16                                  set_page_mode   equ 0x03
    17                                  set_active_page equ 0x05
    18                                  read_cursor     equ 0x08
    19                                  write_cursor    equ 0x09
    20                                  ttype	        equ 0x0E        ; print character, teletype mode	
    21                                  NULL	        equ 0x00        ; end of string marker
    22                                  CR	        equ 0x0D        ; carriage return
    23                                  LF	        equ 0x0A        ; line feed 
    24                                  
    25                                  DBIOS	        equ 0x13        ; BIOS interrupt vector for disk services
    26                                  disk_reset	equ 0x00        ; disk reset service
    27                                  disk_read	equ 0x02        ; disk read service
    28                                  tries           equ 0x03        ; number of times to attempt to access the FDD
    29                                  reset_failure   equ 0x01        ; error code returned on disk reset failure
    30                                  read_failure    equ 0x02        ; error code returned on disk read failure
    31                                  
    32                                  cyl             equ 0x00        ; cylinder to read from
    33                                  head	        equ 0x00        ; head to read from
    34                                  startsector	equ 0x02        ; sector to start reading at
    35                                  numsectors	equ 0x01        ; number of sectors to read
    36                                  
    37                                  
    38                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    39                                  ;; macros
    40                                  ;	
    41                                  %define zero(x) xor x, x
    42                                  			
    43                                  %macro write 1
    44                                     mov si, %1
    45                                     call printstr
    46                                  %endmacro
    47                                  
    48                                  [bits 16]
    49                                  [org stage2_offset]
    50                                  	
    51                                  entry:
    52 00000000 8CC8                       mov ax, cs
    53 00000002 8ED8                       mov ds, ax
    54                                     write success
    55 00000004 BE[2400]            <1>  mov si, %1
    56 00000007 E80100              <1>  call printstr
    57                                  ;  jmp $
    58                                    ; 'return' to the first stage via a faked call frame set up earlier
    59 0000000A CB                        retf
    60                                  
    61                                  
    62                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    63                                  ;; Auxilliary functions      
    64                                  
    65                                  ;; printstr - prints the string point to by SI
    66                                  
    67                                  printstr:
    68 0000000B 50                        push ax
    69 0000000C B40E                      mov ah, ttype        ; set function to 'teletype mode'
    70                                    .print_char:   
    71 0000000E AC                          lodsb               ; update byte to print
    72 0000000F 3C00                        cmp al, NULL        ; test that it isn't NULL
    73 00000011 7404                        jz short .endstr
    74 00000013 CD10                        int  VBIOS          ; put character in AL at next cursor position
    75 00000015 EBF7                        jmp short .print_char
    76                                  .endstr:
    77 00000017 58                        pop ax
    78 00000018 C3                        ret
    79                                  
    80                                  
    81                                  ; reset_disk
    82                                  reset_disk:
    83 00000019 8A16[5800]                mov dl, [bootdrv]
    84 0000001D 30E4                      zero (ah)
    85 0000001F B000                      mov al, disk_reset
    86 00000021 CD13                      int DBIOS
    87 00000023 C3                        ret
    88                                  
    89                                  	
    90                                  ;;;;;;;;;;;;;;;;;;;;;;;;;
    91                                  ;; data
    92 00000024 436F6E74726F6C2073-     success   db 'Control successfully transferred to second stage.', CR, LF, NULL
    93 0000002D 75636365737366756C-
    94 00000036 6C79207472616E7366-
    95 0000003F 657272656420746F20-
    96 00000048 7365636F6E64207374-
    97 00000051 6167652E0D0A00     
    98                                  
    99 00000058 00                      bootdrv	  db 0x00  ; byte reserved for boot drive ID number
   100                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   101                                  ;; pad out to 512
   102                                  
   103 00000059 00<rept>                space   times 0x0200 - ($-$$) db 0 
